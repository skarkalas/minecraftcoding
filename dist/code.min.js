function showErrorModal(e){document.getElementById("errorModalBody").textContent=e;var t=new bootstrap.Modal(document.getElementById("ModalError"));t.show()}let renderer=new THREE.WebGLRenderer;renderer.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(renderer.domElement);let camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,.001,200);function resizeRenderer(){const e=document.getElementById("navbar").offsetHeight,t=window.innerHeight-e;renderer.setSize(window.innerWidth,t),camera.aspect=window.innerWidth/t,camera.updateProjectionMatrix()}resizeRenderer(),window.addEventListener("resize",resizeRenderer),camera.position.y=5;let scene=new THREE.Scene,pause=!1,blockRenderDist=20,fog;addLighting();function addLighting(){let e=new THREE.Color(14745599);const t=new THREE.HemisphereLight(e,5264463,1);scene.background=new THREE.Color(e);let n=new THREE.Color(11184810);fog=new THREE.Fog(n,15,20),scene.fog=fog,scene.add(t)}var hidden=!1;function hideshow(){hidden?(document.getElementById("info").style.visibility="visible",document.getElementById("card").style.height="auto",document.getElementById("showhidebutton").innerHTML="Hide Info",hidden=!1):(document.getElementById("info").style.visibility="hidden",document.getElementById("card").style.height="90px",document.getElementById("showhidebutton").innerHTML="Show Info",hidden=!0)}let controls=new THREE.PointerLockControls(camera,renderer.domElement),clock=new THREE.Clock,btn=document.querySelector("#play");btn.addEventListener("click",e=>{controls.lock();const t={id:e.target.id,type:e.target.nodeName.toLowerCase(),event:e.type,timestamp:new Date().getTime(),state:{playerCoords}};triggerActionEvent(e.type,t)});let isPlaying=!1;function logCameraState(e){console.log(e,`Position: (${camera.position.x}, ${camera.position.y}, ${camera.position.z})`,`Rotation: (${camera.rotation.x}, ${camera.rotation.y}, ${camera.rotation.z})`)}let savedCameraState={position:new THREE.Vector3,rotation:new THREE.Euler},previousRotation={x:camera.rotation.x,y:camera.rotation.y,z:camera.rotation.z};function calculateRotationChanges(){const e={x:camera.rotation.x-previousRotation.x,y:camera.rotation.y-previousRotation.y,z:camera.rotation.z-previousRotation.z};previousRotation={x:camera.rotation.x,y:camera.rotation.y,z:camera.rotation.z};const t=THREE.MathUtils.radToDeg(e.x),n=THREE.MathUtils.radToDeg(e.y),o=THREE.MathUtils.radToDeg(e.z),r=getEvent();r.type="player",r.source="player",r.state.method="mouse",n>0?(r.event="playerTurnLeft",r.state.degrees=Math.abs(n),triggerActionEvent(r.event,r)):n<0&&(r.event="playerTurnRight",r.state.degrees=Math.abs(n),triggerActionEvent(r.event,r)),t>0?(r.event="playerTurnUp",r.state.degrees=Math.abs(t),triggerActionEvent(r.event,r)):t<0&&(r.event="playerTurnDown",r.state.degrees=Math.abs(t),triggerActionEvent(r.event,r))}controls.addEventListener("lock",e=>{btn.style.display="none",pause=!0,isPlaying=!0;const t=getEvent();t.type="cursor",t.event="cursorUnlock",t.source="player",t.state.isLocked=e.target.isLocked,t.state.isPlaying=isPlaying,t.state.playerCoords=playerCoords,t.state.method="keyboard",triggerActionEvent(t.event,t)}),controls.addEventListener("unlock",e=>{camera.position.copy(savedCameraState.position),camera.rotation.copy(savedCameraState.rotation),btn.style.display="block",pause=!1,isPlaying=!1;const t=getEvent();t.type="cursor",t.event="cursorLock",t.source="player",t.state.isLocked=e.target.isLocked,t.state.isPlaying=isPlaying,t.state.playerCoords=playerCoords,t.state.method="keyboard",triggerActionEvent(t.event,t)});let keyboard=[];addEventListener("keydown",e=>{keyboard[e.key]=!0}),addEventListener("keyup",e=>{keyboard[e.key]=!1});let mode=1,prev=new THREE.Vector3(0,25,0),grassSelect=document.getElementById("grassSelect"),dirtSelect=document.getElementById("dirtSelect"),stoneSelect=document.getElementById("stoneSelect"),woodSelect=document.getElementById("woodSelect"),brickSelect=document.getElementById("brickSelect");grassSelect.style.display="block",dirtSelect.style.display="none",stoneSelect.style.display="none",woodSelect.style.display="none",brickSelect.style.display="none";function selectGrass(){if(grassSelect.style.display==="block")return;const e=getEvent();e.type="block",e.event="blockMaterialChangeGrass",e.source="player",e.state.material="grass",arguments.length&&(e.state.method=arguments[0]),triggerActionEvent(e.event,e),placing=1,grassSelect.style.display="block",dirtSelect.style.display="none",stoneSelect.style.display="none",woodSelect.style.display="none",brickSelect.style.display="none"}function selectDirt(){if(dirtSelect.style.display==="block")return;const e=getEvent();e.type="block",e.event="blockMaterialChangeDirt",e.source="player",e.state.material="dirt",arguments.length&&(e.state.method=arguments[0]),triggerActionEvent(e.event,e),placing=6,grassSelect.style.display="none",dirtSelect.style.display="block",stoneSelect.style.display="none",woodSelect.style.display="none",brickSelect.style.display="none"}function selectStone(){if(stoneSelect.style.display==="block")return;const e=getEvent();e.type="block",e.event="blockMaterialChangeStone",e.source="player",e.state.material="stone",arguments.length&&(e.state.method=arguments[0]),triggerActionEvent(e.event,e),placing=2,grassSelect.style.display="none",dirtSelect.style.display="none",stoneSelect.style.display="block",woodSelect.style.display="none",brickSelect.style.display="none"}function selectWood(){if(woodSelect.style.display==="block")return;const e=getEvent();e.type="block",e.event="blockMaterialChangeWood",e.source="player",e.state.material="wood",arguments.length&&(e.state.method=arguments[0]),triggerActionEvent(e.event,e),placing=3,grassSelect.style.display="none",dirtSelect.style.display="none",stoneSelect.style.display="none",woodSelect.style.display="block",brickSelect.style.display="none"}function selectBrick(){if(brickSelect.style.display==="block")return;const e=getEvent();e.type="block",e.event="blockMaterialChangeBrick",e.source="player",e.state.material="brick",arguments.length&&(e.state.method=arguments[0]),triggerActionEvent(e.event,e),placing=7,grassSelect.style.display="none",dirtSelect.style.display="none",stoneSelect.style.display="none",woodSelect.style.display="none",brickSelect.style.display="block"}function processKeyboard(e){let n=3*e;const o=getEvent();if(o.state.method="keyboard",o.state.distance=1,keyboard.w&&(controls.moveForward(n),o.type="player",o.event="playerMoveForward",o.source="player",checkWalls()),keyboard.s&&(controls.moveForward(-n),o.type="player",o.event="playerMoveBackward",o.source="player",checkWalls()),keyboard.a&&(controls.moveRight(-n),o.type="player",o.event="playerMoveLeft",o.source="player",checkWalls()),keyboard.d&&(controls.moveRight(n),o.type="player",o.event="playerMoveRight",o.source="player",checkWalls()),keyboard[" "]&&(mode==0?canJump&&(velocity.y=2,canJump=!1):(camera.position.y+=n,o.type="player",o.event="playerMoveUp",o.source="player",checkWalls())),keyboard.q&&(camera.position.y-=n,o.type="player",o.event="playerMoveDown",o.source="player",checkWalls()),keyboard[1]){selectGrass("keyboard");return}if(keyboard[2]){selectDirt("keyboard");return}if(keyboard[3]){selectStone("keyboard");return}if(keyboard[4]){selectWood("keyboard");return}if(keyboard[5]){selectBrick("keyboard");return}o.event&&triggerActionEvent(o.event,o)}function checkWalls(){let e=Math.floor(camera.position.x+.5),t=Math.floor(camera.position.y+.5),n=Math.floor(camera.position.z+.5),o=getKey(e,n),r=getKey(Math.floor(prev.x,prev.z));data[o][t]?(camera.position.x=prev.x,camera.position.y=prev.y,camera.position.z=prev.z):prev=new THREE.Vector3(camera.position.x,camera.position.y,camera.position.z)}let data=new Map,placing=1,diamondsFound=0,diamondCount=document.getElementById("diamondCount"),cursorCoords={x:0,y:0,z:0},isDragging=!1,previousMousePosition={x:0,y:0};window.onmousemove=function(e){e=e||window.event,savedCameraState.position.copy(camera.position),savedCameraState.rotation.copy(camera.rotation)},document.addEventListener("mousedown",function(e){if(isPlaying){if(isDragging=!0,previousMousePosition.x=e.clientX,previousMousePosition.y=e.clientY,e=e||window.event,e.keyCode||e.which==1)INTERSECTED&&INTERSECTED.name!="bottom"&&pause&&destroyBlock(INTERSECTED.position.x,INTERSECTED.position.y,INTERSECTED.position.z,"mouse","player");else if((e.keyCode||e.which==3)&&INTERSECTED){let t=INTERSECTED.position.x+face.normal.x,n=INTERSECTED.position.y+face.normal.y,o=INTERSECTED.position.z+face.normal.z,r=getKey(t,o),a=Math.floor(camera.position.x+.5),s=Math.floor(camera.position.y+.5),l=Math.floor(camera.position.z+.5);(t!=a||n!=s||o!=l)&&data[r][n]==null&&(data[r][n]=drawBlock(t,o,n,placing,"mouse","player"))}}}),document.addEventListener("mouseup",function(e){isDragging=!1});function destroyBlock(e,t,n){let o=getKey(e,n),r=data[o][t];if(!r)throw new Error(`There is no block to destroy at position ${e},${t},${n}`);const a=getEvent();a.state.method=arguments[3]||"system",a.type="block",a.event="destroyBlock",a.source=arguments[4]||"system",a.state.material=r.meta.state.material,a.state.blockCoords={x:e,y:t,z:n},a.source==="player"&&(history.push(a),console.log(history)),triggerActionEvent("destroy",a),scene.remove(r),data[o][t]=null,data[o][t-1]&&(data[o][t-1].visible=!0),data[o][t+1]&&(data[o][t+1].visible=!0),o=getKey(e+1,n),data[o][t]&&(data[o][t].visible=!0),o=getKey(e-1,n),data[o][t]&&(data[o][t].visible=!0),o=getKey(e,n+1),data[o][t]&&(data[o][t].visible=!0),o=getKey(e,n-1),data[o][t]&&(data[o][t].visible=!0)}let toAdd=[];noise.seed(Math.random());function getHeightValue(e,t){return 2+Math.floor(16*Math.abs(noise.perlin2(e/50,t/50)))}function getBlock(e,t,n){return data[getKey(e,n)][t]}function getKey(e,t){return e+","+t}function generateCoordinate(e,t){var n=getHeightValue(e,t);let o=getKey(e,t);data[o]||(data[o]=new Map);let r=drawBlock(e,t,n,1);data[o][n]=r;for(let a=n-1;a>=0;a--){let s;a==0?(s=drawBlock(e,t,a,0),s.name="bottom"):a==n-1?s=drawBlock(e,t,a,6):Math.floor(Math.random()*200)+1==5?s=drawBlock(e,t,a,5):s=drawBlock(e,t,a,2),s.visible=!1,data[o][a]=s}if(Math.floor(Math.random()*150)+1==5){let a=Math.floor(Math.random()*3+4.5);for(let l=1;l<a;l++){let i=drawBlock(e,t,n+l,3);data[o][n+l]=i,l>=3&&(i=drawBlock(e+1,t,n+l,4),toAdd.push(i),i=drawBlock(e-1,t,n+l,4),toAdd.push(i),i=drawBlock(e,t+1,n+l,4),toAdd.push(i),i=drawBlock(e,t-1,n+l,4),toAdd.push(i))}let s=drawBlock(e,t,n+a,4);data[o][n+a]=s}}let base=new THREE.BoxGeometry(1,1,1),loader=new THREE.TextureLoader,grassMap=loader.load("textures/grassTop.jpeg"),dirtMap=new THREE.TextureLoader().load("textures/dirt.jpeg"),stoneMap=loader.load("textures/stone.jpeg"),treeMap=loader.load("textures/tree.jpeg"),leafMap=loader.load("textures/leaf.png"),diamondMap=loader.load("textures/diamond.jpeg"),bottomMap=loader.load("textures/bedrock.png"),brickMap=loader.load("textures/brick.png");const history=[];let m,materialTxt;function drawBlock(e,t,n,o){switch(o){case 0:m=bottomMap,materialTxt="bottom";break;case 1:m=grassMap,materialTxt="grass";break;case 2:m=stoneMap,materialTxt="stone";break;case 3:m=treeMap,materialTxt="tree";break;case 4:m=leafMap,materialTxt="leaf";break;case 5:m=diamondMap,materialTxt="diamond";break;case 6:m=dirtMap,materialTxt="dirt";break;case 7:m=brickMap,materialTxt="brick";break}const r=getEvent();r.state.method=arguments[4]||"system",r.type="block",r.event="createBlock",r.source=arguments[5]||"system",r.state.material=materialTxt,r.state.blockCoords={x:e,y:n,z:t},r.source==="player"&&(history.push(r),console.log(history)),triggerActionEvent(r.event,r);let a=base.clone();var s=new THREE.MeshPhongMaterial({map:m,vertexColors:THREE.FaceColors}),l=new THREE.Mesh(a,s);return l.position.x=e,l.position.y=n,l.position.z=t,l.name="block",l.meta=r,scene.add(l),l.castShadow=!0,l.receiveShadow=!0,l}let prevX=1,prevZ=1;function processLand(){let e=Math.floor(camera.position.x+.5),t=Math.floor(camera.position.z+.5);(e!=prevX||t!=prevZ)&&(camera.position.x%1<=.1||camera.position.z%1<=.1)&&(drawBlocks(e,t),removeBlocks(e,t),prevX=e,prevZ=t)}let renderDistSlider;function displayGUI(){const e=new GUI;let t={a:20};renderDistSlider=e.add(t,"a").min(15).max(100).step(1).name("Render Distance (Blocks)"),e.open()}function generateStart(){drawStart();let e=0,t=getKey(0,0);for(var n in data[t])data[t][n].position.y>e&&(e=data[t][n].position.y);for(camera.position.y=e+3;data[t][camera.position.y]!=null;)camera.position.y++}function drawStart(){let e=Math.floor(camera.position.x+.5),t=Math.floor(camera.position.z+.5);for(let n=-blockRenderDist-2+e;n<=blockRenderDist+2+e;n++)for(let o=-blockRenderDist-2+t;o<=blockRenderDist+2+t;o++)data[getKey(n,o)]?drawCoord(n,o):generateCoordinate(n,o)}function updateCrossovers(){for(var e in toAdd){let t=toAdd[e],n=t.position.x,o=t.position.y,r=t.position.z,a=getKey(n,r);data[a]||generateCoordinate(n,r),data[a][o]=t}for(let t=0;t<toAdd.length;t++)toAdd.pop()}function drawCoord(e,t){let n=getKey(e,t),o=data[n];if(o!=null)for(var r in o){let a=o[r];a!=null&&(scene.children.includes(a)||scene.add(a))}else generateCoordinate(e,t)}function drawBlocks(e,t){updateCrossovers();for(let n=t+blockRenderDist-2;n<=t+blockRenderDist;n++)for(let o=e-blockRenderDist;o<=e+blockRenderDist;o++)drawCoord(o,n);for(let n=t-blockRenderDist+2;n>=t-blockRenderDist;n--)for(let o=e-blockRenderDist;o<=e+blockRenderDist;o++)drawCoord(o,n);for(let n=e+blockRenderDist-2;n<=e+blockRenderDist;n++)for(let o=t-blockRenderDist;o<=t+blockRenderDist;o++)drawCoord(n,o);for(let n=e-blockRenderDist+2;n>=e-blockRenderDist;n--)for(let o=t-blockRenderDist;o<=t+blockRenderDist;o++)drawCoord(n,o)}function removeBlocks(e,t){for(var n in scene.children){let o=scene.children[n];(o.name=="block"||o.name=="bottom")&&(Math.abs(t-o.position.z)>blockRenderDist-.9||Math.abs(e-o.position.x)>blockRenderDist-.9)&&scene.remove(o)}}let velocity=new THREE.Vector3(0,0,0),time=0,canJump=!1;function playerPhysics(e,t){let n=Math.floor(camera.position.x+.5),o=Math.floor(camera.position.y+.5),r=Math.floor(camera.position.z+.5),a=getKey(n,r),s=e*t;data[a][o-2]==null?(camera.position.y+=s*velocity.y,velocity.y-=10*t):(velocity.y<0&&(velocity.y=0),camera.position.y+=s*velocity.y)}let INTERSECTED,face,col;function checkMouse(){let e=new THREE.Raycaster;const t=new THREE.Vector2(0,0);e.setFromCamera(t,camera);const n=e.intersectObjects(scene.children);if(n.length>0&&Math.abs(Math.sqrt(Math.pow(n[0].point.x-camera.position.x,2)+Math.pow(n[0].point.y-camera.position.y,2)+Math.pow(n[0].point.z-camera.position.z,2)))<12){if(face!=n[0].face){if(face){let r=INTERSECTED.geometry.faces;for(let a=0;a<r.length;a++)r[a].color.setRGB(col.r,col.g,col.b);INTERSECTED.geometry.colorsNeedUpdate=!0}face=n[0].face,INTERSECTED=n[0].object;let o=INTERSECTED.geometry.faces;for(let r=0;r<o.length;r++)o[r].normal.x==face.normal.x&&o[r].normal.y==face.normal.y&&o[r].normal.z==face.normal.z?o[r].color.setRGB(o[r].color.r+1,o[r].color.g+1,o[r].color.b+1):col=o[r].color;INTERSECTED.geometry.colorsNeedUpdate=!0}}else{if(face){let o=INTERSECTED.geometry.faces;for(let r=0;r<o.length;r++)o[r].color.setRGB(col.r,col.g,col.b);INTERSECTED.geometry.colorsNeedUpdate=!0}face=null,INTERSECTED=null}}let playerCoordsUI=document.getElementById("playerCoords"),playerCoords={};function getCameraPosition(){return playerCoords.x=Math.floor(camera.position.x+.5),playerCoords.y=Math.floor(camera.position.y+.5),playerCoords.z=Math.floor(camera.position.z+.5),playerCoordsUI.innerHTML="(x:"+playerCoords.x+", y:"+playerCoords.y+", z:"+playerCoords.z+")",{x:playerCoords.x,y:playerCoords.y,z:playerCoords.z}}getCameraPosition();function getCursorPosition(){if(INTERSECTED){let e=INTERSECTED.position.x+face.normal.x,t=INTERSECTED.position.y+face.normal.y,n=INTERSECTED.position.z+face.normal.z,o=playerCoords.x,r=playerCoords.y,a=playerCoords.y;if(e!=o||t!=r||n!=a){cursorCoords.x=e,cursorCoords.y=t,cursorCoords.z=n;let s=document.getElementById("cursorCoords");s.innerHTML="(x:"+cursorCoords.x+", y:"+cursorCoords.y+", z:"+cursorCoords.z+")"}}return{x:cursorCoords.x||0,y:cursorCoords.y||0,z:cursorCoords.z||0}}getCursorPosition();function drawScene(){renderer.render(scene,camera);let e=clock.getDelta();pause&&(processLand(),processKeyboard(e),checkMouse(),calculateRotationChanges(),getCameraPosition(),getCursorPosition()),requestAnimationFrame(drawScene)}generateStart(),drawScene();function getEvent(){return{id:uuidv1(),type:"",event:null,timestamp:new Date().getTime(),source:"system",state:{method:"blockly",playerCoords}}}const keyMapping={w:{code:"KeyW",keyCode:87},a:{code:"KeyA",keyCode:65},s:{code:"KeyS",keyCode:83},d:{code:"KeyD",keyCode:68}," ":{code:"Space",keyCode:32},q:{code:"KeyQ",keyCode:81},1:{code:"Digit1",keyCode:49},2:{code:"Digit2",keyCode:50},3:{code:"Digit3",keyCode:51},4:{code:"Digit4",keyCode:52},5:{code:"Digit5",keyCode:53}};function simulateKeyEvent(e,t){if(!keyMapping[e]){console.log(`Unsupported key: ${e}`);return}const{code:n,keyCode:o}=keyMapping[e];return new KeyboardEvent(t,{key:e,code:n,keyCode:o,which:o,bubbles:!0,cancelable:!0})}function animateCameraRotation(e,t,n){const o=getEvent();o.state.degrees=t,o.type="player",o.source="player";const r=THREE.MathUtils.degToRad(t);let a={x:camera.rotation.x,y:camera.rotation.y,z:camera.rotation.z};switch(e){case"right":o.event="playerTurnRight",triggerActionEvent(o.event,o),a.y-=r;break;case"left":o.event="playerTurnLeft",triggerActionEvent(o.event,o),a.y+=r;break;case"down":o.event="playerTurnDown",triggerActionEvent(o.event,o),a.x-=r;break;case"up":o.event="playerTurnUp",triggerActionEvent(o.event,o),a.x+=r;break;default:console.error("Invalid direction:",e);return}function s(l,i){const d={x:camera.rotation.x,y:camera.rotation.y,z:camera.rotation.z},p={x:l.x-d.x,y:l.y-d.y,z:l.z-d.z},u=performance.now();function c(y){const f=y-u;if(f>=i){camera.rotation.set(l.x,l.y,l.z);return}const g=f/i,h={x:d.x+p.x*g,y:d.y+p.y*g,z:d.z+p.z*g};camera.rotation.set(h.x,h.y,h.z),requestAnimationFrame(c)}requestAnimationFrame(c)}s(a,n)}function animateCameraMovement(e,t,n){const o=camera.position.clone(),r=o.clone(),a=getEvent();switch(a.state.distance=t,a.type="player",a.source="player",e){case"forward":camera.getWorldDirection(r),r.multiplyScalar(t),r.add(o),a.event="playerMoveForward",triggerActionEvent(a.event,a);break;case"backward":camera.getWorldDirection(r),r.multiplyScalar(-t),r.add(o),a.event="playerMoveBackward",triggerActionEvent(a.event,a);break;case"left":const i=new THREE.Vector3(-1,0,0);i.applyQuaternion(camera.quaternion),r.addScaledVector(i,t),a.event="playerMoveLeft",triggerActionEvent(a.event,a);break;case"right":const d=new THREE.Vector3(1,0,0);d.applyQuaternion(camera.quaternion),r.addScaledVector(d,t),a.event="playerMoveRight",triggerActionEvent(a.event,a);break;case"up":r.y+=t,a.event="playerMoveUp",triggerActionEvent(a.event,a);break;case"down":r.y-=t,a.event="playerMoveDown",triggerActionEvent(a.event,a);break;default:console.error("Invalid direction:",e);return}const s=performance.now();function l(i){const d=i-s;if(d>=n){camera.position.copy(r);return}const p=d/n,u=o.clone().lerp(r,p);camera.position.copy(u),requestAnimationFrame(l)}requestAnimationFrame(l)}function triggerActionEvent(e,t){const n=new CustomEvent(e,{detail:t});document.dispatchEvent(n)}document.querySelector("#save").addEventListener("click",e=>{function t(r,a){var s=new Blob([a],{type:"application/json;charset=utf-8"}),l=URL.createObjectURL(s),i=document.createElement("a");i.setAttribute("href",l),i.setAttribute("download",r),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(l)}let n={blocks:null,player:{position:camera.position.clone(),rotation:camera.rotation.clone()}};function o(r){function a(l){const i={position:l.meta.state.blockCoords,material:l.meta.state.material,materialno:0};switch(i.material){case"bottom":i.materialno=0;break;case"grass":i.materialno=1;break;case"stone":i.materialno=2;break;case"tree":i.materialno=3;break;case"leaf":i.materialno=4;break;case"diamond":i.materialno=5;break;case"dirt":i.materialno=6;break;case"brick":i.materialno=7;break;default:i.materialno=1}return i}const s=[];for(let l in r)if(r.hasOwnProperty(l)){let i=r[l];for(let d in i)if(i.hasOwnProperty(d)){const p=i[d];if(p!==null)try{s.push(a(p))}catch(u){console.error("Error serializing mesh:",u),alert("An error occurred while serializing the mesh: "+u.message)}}}return s}n.blocks=o(data),console.log(n),t(uuidv1()+".json",JSON.stringify(n,null,2))}),document.querySelector("#load").addEventListener("click",e=>{document.querySelector("input#load-scene").click()}),document.querySelector("input#load-scene").addEventListener("change",e=>{const t=document.getElementById("spinnerContainer");t.style.display==="none"&&(t.style.display="block");const n=e.currentTarget,o=new FileReader;o.onload=function(){try{let d=function(c){for(;c.children.length>0;){const y=c.children[0];c.remove(y),p(y)}},p=function(c){c.geometry&&c.geometry.dispose(),c.material&&(Array.isArray(c.material)?c.material.forEach(y=>y.dispose()):c.material.dispose()),c.texture&&c.texture.dispose(),c.children&&c.children.forEach(y=>p(y))},u=function(c){try{c.forEach(y=>{const f=y.position,g=y.materialno;let h=getKey(f.x,f.z);data[h]||(data[h]=new Map),data[h][f.y]=drawBlock(f.x,f.z,f.y,g)})}catch(y){console.log(y)}};var r=d,a=p,s=u;const l=o.result;let i;try{i=JSON.parse(l)}catch(c){console.error("Failed to parse JSON:",c)}if(console.log(l),console.log(i),i.blocks.length===0){showErrorModal("There is no game to load."),t.style.setProperty("display","none","important");return}d(scene),addLighting(),data=new Map,u(i.blocks),camera.position.copy(i.player.position),camera.rotation.copy(i.player.rotation),t.style.display==="block"&&t.style.setProperty("display","none","important")}catch(l){console.log(l),t.style.setProperty("display","none","important"),showErrorModal("No valid game found.")}},o.readAsText(n.files[0])}),document.querySelector("#undo").addEventListener("click",e=>{if(Array.isArray(history)&&history.length>0){const t=history.pop();let n,o,r,a,s,l;switch(t.event){case"createBlock":if(n=t.state.blockCoords.x,o=t.state.blockCoords.y,r=t.state.blockCoords.z,a=getKey(n,r),l=data[a][o],!l){showErrorModal(`There is no block to destroy at position ${n},${o},${r}`);break}scene.remove(l),data[a][o]=null;break;case"destroyBlock":switch(n=t.state.blockCoords.x,o=t.state.blockCoords.y,r=t.state.blockCoords.z,a=getKey(n,r),t.state.material){case"bottom":s=0;break;case"grass":s=1;break;case"stone":s=2;break;case"tree":s=3;break;case"leaf":s=4;break;case"diamond":s=5;break;case"dirt":s=6;break;case"brick":s=7;break;default:s=1}data[a][o]=drawBlock(n,r,o,s);break;default:}}else showErrorModal("No items in history")});function exportScene(e){let t="";const n=new OBJExporter;return e.traverse(function(o){if(o.isMesh&&o.meta&&o.meta.source==="player"){const r=n.parse(o);t+=r}}),t}document.addEventListener("playerPositionChange",e=>{console.log("Action:",e.detail)}),document.addEventListener("cursorPositionChange",e=>{console.log("Action:",e.detail)}),document.addEventListener("playerMoveForward",e=>{console.log("Action:",e.detail)}),document.addEventListener("playerMoveBackward",e=>{console.log("Action:",e.detail)}),document.addEventListener("playerMoveLeft",e=>{console.log("Action:",e.detail)}),document.addEventListener("playerMoveRight",e=>{console.log("Action:",e.detail)}),document.addEventListener("playerMoveUp",e=>{console.log("Action:",e.detail)}),document.addEventListener("playerMoveDown",e=>{console.log("Action:",e.detail)}),document.addEventListener("playerTurnRight",e=>{console.log("Action:",e.detail)}),document.addEventListener("playerTurnLeft",e=>{console.log("Action:",e.detail)}),document.addEventListener("playerTurnUp",e=>{console.log("Action:",e.detail)}),document.addEventListener("playerTurnDown",e=>{console.log("Action:",e.detail)}),document.addEventListener("blockMaterialChangeGrass",e=>{console.log("Action:",e.detail)}),document.addEventListener("blockMaterialChangeDirt",e=>{console.log("Action:",e.detail)}),document.addEventListener("blockMaterialChangeStone",e=>{console.log("Action:",e.detail)}),document.addEventListener("blockMaterialChangeWood",e=>{console.log("Action:",e.detail)}),document.addEventListener("blockMaterialChangeBrick",e=>{console.log("Action:",e.detail)}),document.addEventListener("createBlock",e=>{console.log("Action:",e.detail)}),document.addEventListener("destroyBlock",e=>{console.log("Action:",e.detail)}),document.addEventListener("cursorLock",e=>{console.log("Action:",e.detail)}),document.addEventListener("cursorUnlock",e=>{console.log("Action:",e.detail)}),document.addEventListener("createBlocklyBlock",e=>{console.log("Action:",e.detail)}),document.addEventListener("deleteBlocklyBlock",e=>{console.log("Action:",e.detail)}),document.addEventListener("executeBlocklyCode",e=>{console.log("Action:",e.detail)});const Minecraft={getPlayerPosition:()=>{try{const e=getEvent();return e.event="playerPositionChange",e.type="player",e.source="player",e.state.playerCoords=getCameraPosition(),triggerActionEvent(e.event,e),Object.values(e.state.playerCoords)}catch(e){throw showErrorModal(e.message),e}},getCursorPosition:()=>{try{const e=getEvent();return e.event="cursorPositionChange",e.type="cursor",e.source="player",e.state.cursorCoords=getCursorPosition(),triggerActionEvent(e.event,e),Object.values(e.state.cursorCoords)}catch(e){throw showErrorModal(e.message),e}},moveForward:e=>{try{animateCameraMovement("forward",e,1e3)}catch(t){throw showErrorModal(t.message),t}},moveBackward:e=>{try{animateCameraMovement("backward",e,1e3)}catch(t){throw showErrorModal(t.message),t}},moveRight:e=>{try{animateCameraMovement("right",e,1e3)}catch(t){throw showErrorModal(t.message),t}},moveLeft:e=>{try{animateCameraMovement("left",e,1e3)}catch(t){throw showErrorModal(t.message),t}},moveUp:e=>{try{animateCameraMovement("up",e,1e3)}catch(t){throw showErrorModal(t.message),t}},moveDown:e=>{try{animateCameraMovement("down",e,1e3)}catch(t){throw showErrorModal(t.message),t}},turnRight:e=>{try{animateCameraRotation("right",e,1e3)}catch(t){throw showErrorModal(t.message),t}},turnLeft:e=>{try{animateCameraRotation("left",e,1e3)}catch(t){throw showErrorModal(t.message),t}},turnUp:e=>{try{animateCameraRotation("up",e,1e3)}catch(t){throw showErrorModal(t.message),t}},turnDown:e=>{try{animateCameraRotation("down",e,1e3)}catch(t){throw showErrorModal(t.message),t}},selectGrass:()=>{try{selectGrass()}catch(e){throw showErrorModal(e.message),e}},selectDirt:()=>{try{selectDirt()}catch(e){throw showErrorModal(e.message),e}},selectStone:()=>{try{selectStone()}catch(e){throw showErrorModal(e.message),e}},selectWood:()=>{try{selectWood()}catch(e){throw showErrorModal(e.message),e}},selectBrick:()=>{try{selectBrick()}catch(e){throw showErrorModal(e.message),e}},createBlock:(e,t,n)=>{try{data[[e,n]][t]==null&&(data[[e,n]][t]=drawBlock(e,n,t,placing,"blockly","player"))}catch(o){throw showErrorModal(o.message),o}},destroyBlock:(e,t,n)=>{try{destroyBlock(e,t,n,"blockly","player")}catch(o){throw showErrorModal(o.message),o}}};
